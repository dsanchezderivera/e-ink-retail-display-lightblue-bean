#include <inttypes.h>
#include <avr/power.h>
#include <SPI.h>
#include <avr/wdt.h>


// this holds all serial input until a full command is in it
String cmdBuffer;


void setup()
{
  // initialize serial communication at 57600 bits per second:
  Serial.begin(57600);

  // on readBytes, return after 25ms or when the buffer is full
  Serial.setTimeout(25);
}


void loop()
{
  char buffer[64];
  size_t length = 64; 
  length = Serial.readBytes( buffer, length-1 );
  buffer[length] = 0;
  if ( length > 0 )
  {
    cmdBuffer += buffer;
    size_t lineEnd = cmdBuffer.indexOf( "\n" );
    if ( lineEnd > 0 )
    {
      // copy off the command, reusing our buffer variable
      cmdBuffer.substring( 0, lineEnd ).toCharArray( buffer, 64 );

      // and remove it from the command buffer
      cmdBuffer = cmdBuffer.substring( lineEnd+1, cmdBuffer.length()+1 );

      // now we can do something with the command...

      // hello ... world
      if ( !strncmp( buffer, "hello", 5 ) )
      {
        Serial.println( "< world >" ); 
      }

      // request temperature data
      else if ( !strncmp( buffer, "temp", 4 ) )
      {
        int8_t newTemp = Bean.getTemperature();
        Serial.println( String("< Temperature: ") + String(newTemp) + "c >" );
      }

      // request accelerometer data
      else if ( !strncmp( buffer, "acc", 3 ) )
      {
        int8_t x = Bean.getAccelerationX();
        int8_t y = Bean.getAccelerationY();
        int8_t z = Bean.getAccelerationZ();
        Serial.println( String("< Accelerometer: ") + String(x) +","+ String(y) +","+ String(z) + " >" );
      }

      // setting the LED color
      else if ( !strncmp( buffer, "led", 3 ) )
      {
        char temp[64];

        char *tok = buffer;
        char *param = NULL;
        param = strtok_r( tok, " ", &tok ); // first is the "led" command
        uint8_t r = atoi( strtok_r( tok, " ", &tok ) ); // red
        uint8_t g = atoi( strtok_r( tok, " ", &tok ) ); // green
        uint8_t b = atoi( strtok_r( tok, " ", &tok ) ); // blue

        Bean.setLed( r, g, b );
        oldLed = Bean.getLed();
        Serial.println( String("< LED set to ") + String(r) +","+ String(g) +","+ String(b) + " >" );
      }

      // blink
      else if ( !strncmp( buffer, "blink", 5 ) )
      {
        doBlink = !doBlink;
        if ( doBlink && ( Bean.getLedRed() + Bean.getLedGreen() + Bean.getLedBlue() == 0 ) )
          Bean.setLed( 255, 255, 255 );
        else if ( !doBlink )
          Bean.setLed( 0, 0, 0 );
        oldLed = Bean.getLed();
        Serial.println( String("< Blink ") + (doBlink?"ON":"OFF") + " >" );
      }

      // everything else, just echo it
      else
      {
        Serial.println( String("< ") + buffer + " >" ); 
      }
    }
  }

  if ( doBlink )
  {
    blinkCnt = ++blinkCnt % 10;
    if ( blinkCnt == 0 )
    {
      if ( blinkState )
        Bean.setLed( 0, 0, 0 );
      else
        Bean.setLed( oldLed.red, oldLed.green, oldLed.blue );
      blinkState = !blinkState;
    }
  }

  Bean.sleep(50);
}